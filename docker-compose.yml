version: "3.8"

services:
  app:
    build: .
    image: calyra-ai:latest
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      JDBC_URL: ${JDBC_URL:-jdbc:postgresql://postgres:5432/${POSTGRES_DB:-calyra}}
      JDBC_USERNAME: ${JDBC_USERNAME:-calyra}
      JDBC_PASSWORD: ${JDBC_PASSWORD:-calyra}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
    depends_on:
      - postgres
      - qdrant
    ports:
      - "8080:8080"
    restart: unless-stopped
    networks:
      - calyra_net

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-calyra}
      POSTGRES_USER: ${POSTGRES_USER:-calyra}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-calyra}
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - calyra_net

  qdrant:
    image: qdrant/qdrant:v1.8.4
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - calyra_net

volumes:
  pg_data:
  qdrant_data:

networks:
  calyra_net:
